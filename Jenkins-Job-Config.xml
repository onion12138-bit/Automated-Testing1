<?xml version='1.1' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Ford Smart Badge æ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯•ä»»åŠ¡</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.disk__usage.DiskUsageProperty/>
    <hudson.model.BuildDiscarderProperty>
      <strategy class="hudson.model.LogRotator">
        <daysToKeep>30</daysToKeep>
        <numToKeep>50</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </hudson.model.BuildDiscarderProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers>
    <!-- å®šæ—¶è§¦å‘å™¨é…ç½® -->
    <hudson.triggers.TimerTrigger>
      <!-- æ¯å¤©ä¸Šåˆ9ç‚¹ã€ä¸‹åˆ14:30å’Œä¸‹åˆ17:05æ‰§è¡Œ -->
      <spec>0 9,14,17 * * *</spec>
    </hudson.triggers.TimerTrigger>
  </triggers>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash

# Ford Smart Badge æ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
# é€šè¿‡Jenkinsæ‰§è¡Œï¼Œæ¯”cronæ›´å¯é 

echo "========================================="
echo "ğŸš€ å¼€å§‹æ‰§è¡ŒFord Smart Badgeè‡ªåŠ¨åŒ–æµ‹è¯•"
echo "========================================="
echo "æ‰§è¡Œæ—¶é—´: $(date)"
echo "Jenkinså·¥ä½œç›®å½•: $WORKSPACE"
echo "========================================="

# è®¾ç½®å·¥ä½œç›®å½•
WORKSPACE_DIR="/Users/onion/Desktop/JmeterMac2"
cd "$WORKSPACE_DIR"

# è®°å½•æ—¥å¿—
LOG_FILE="$WORKSPACE_DIR/jenkins-test.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "=========================================" >> "$LOG_FILE"
echo "ğŸ• Jenkinså¼€å§‹æ‰§è¡Œæ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯• - $TIMESTAMP" >> "$LOG_FILE"
echo "=========================================" >> "$LOG_FILE"

# æ£€æŸ¥å·¥ä½œç›®å½•
if [ ! -d "$WORKSPACE_DIR" ]; then
    echo "âŒ é”™è¯¯: å·¥ä½œç›®å½•ä¸å­˜åœ¨: $WORKSPACE_DIR" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: å·¥ä½œç›®å½•ä¸å­˜åœ¨: $WORKSPACE_DIR"
    exit 1
fi

echo "ğŸ“ å·¥ä½œç›®å½•: $WORKSPACE_DIR" >> "$LOG_FILE"
echo "ğŸ“ å·¥ä½œç›®å½•: $WORKSPACE_DIR"

# æ£€æŸ¥å¿…è¦æ–‡ä»¶
if [ ! -f "$WORKSPACE_DIR/build.xml" ]; then
    echo "âŒ é”™è¯¯: build.xmlæ–‡ä»¶ä¸å­˜åœ¨" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: build.xmlæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

if [ ! -f "$WORKSPACE_DIR/jmeter-script/Ford-Smart-API-Test.jmx" ]; then
    echo "âŒ é”™è¯¯: JMeteræµ‹è¯•è„šæœ¬ä¸å­˜åœ¨" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: JMeteræµ‹è¯•è„šæœ¬ä¸å­˜åœ¨"
    exit 1
fi

echo "âœ… å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡" >> "$LOG_FILE"
echo "âœ… å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

# æ‰§è¡ŒAntæ„å»º
echo "ğŸš€ å¼€å§‹æ‰§è¡ŒAntæ„å»º..." >> "$LOG_FILE"
echo "ğŸš€ å¼€å§‹æ‰§è¡ŒAntæ„å»º..."
ant run >> "$LOG_FILE" 2>&1

# æ£€æŸ¥æ‰§è¡Œç»“æœ
if [ $? -eq 0 ]; then
    echo "âœ… Antæ„å»ºæ‰§è¡ŒæˆåŠŸ" >> "$LOG_FILE"
    echo "âœ… Antæ„å»ºæ‰§è¡ŒæˆåŠŸ"
    
    # æŸ¥æ‰¾æœ€æ–°çš„ZIPæŠ¥å‘Šæ–‡ä»¶
    LATEST_ZIP=$(ls -t /tmp/JMeter_Report_*.zip 2>/dev/null | head -1)
    
    if [ -n "$LATEST_ZIP" ] && [ -f "$LATEST_ZIP" ]; then
        echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š: $LATEST_ZIP" >> "$LOG_FILE"
        echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š: $LATEST_ZIP"
        
        # å‘é€é‚®ä»¶é€šçŸ¥
        echo "ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥..." >> "$LOG_FILE"
        echo "ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥..."
        
        # ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶
        if [ -f "$WORKSPACE_DIR/send-email-python.py" ]; then
            echo "ğŸ ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶..." >> "$LOG_FILE"
            echo "ğŸ ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶..."
            
            cd "$WORKSPACE_DIR"
            python3 send-email-python.py
            MAIL_RESULT=$?
            
            if [ $MAIL_RESULT -eq 0 ]; then
                echo "âœ… é‚®ä»¶å‘é€æˆåŠŸ (ä½¿ç”¨Pythonè„šæœ¬)" >> "$LOG_FILE"
                echo "âœ… é‚®ä»¶å‘é€æˆåŠŸ (ä½¿ç”¨Pythonè„šæœ¬)"
            else
                echo "âŒ Pythoné‚®ä»¶å‘é€å¤±è´¥" >> "$LOG_FILE"
                echo "âŒ Pythoné‚®ä»¶å‘é€å¤±è´¥"
            fi
        else
            echo "âŒ Pythoné‚®ä»¶è„šæœ¬ä¸å­˜åœ¨" >> "$LOG_FILE"
            echo "âŒ Pythoné‚®ä»¶è„šæœ¬ä¸å­˜åœ¨"
        fi
    else
        echo "âš ï¸ æœªæ‰¾åˆ°ZIPæŠ¥å‘Šæ–‡ä»¶" >> "$LOG_FILE"
        echo "âš ï¸ æœªæ‰¾åˆ°ZIPæŠ¥å‘Šæ–‡ä»¶"
    fi
else
    echo "âŒ Antæ„å»ºæ‰§è¡Œå¤±è´¥" >> "$LOG_FILE"
    echo "âŒ Antæ„å»ºæ‰§è¡Œå¤±è´¥"
fi

# è®°å½•å®Œæˆæ—¶é—´
END_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "=========================================" >> "$LOG_FILE"
echo "ğŸ Jenkinsæ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ - $END_TIMESTAMP" >> "$LOG_FILE"
echo "=========================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find "$WORKSPACE_DIR" -name "jenkins-test.log" -mtime +30 -delete 2>/dev/null

echo "========================================="
echo "ğŸ‰ Jenkinsè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬æ‰§è¡Œå®Œæˆï¼"
echo "ğŸ“§ æµ‹è¯•æŠ¥å‘Šå·²å‘é€åˆ°: 2335327949@qq.com"
echo "ğŸ“„ è¯¦ç»†æ—¥å¿—: $LOG_FILE"
echo "========================================="</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.tasks.Mailer plugin="mailer@1.35">
      <recipients>2335327949@qq.com</recipients>
      <dontNotifyEveryUnstableBuild>false</dontNotifyEveryUnstableBuild>
      <sendToIndividuals>false</sendToIndividuals>
    </hudson.tasks.Mailer>
  </publishers>
  <buildWrappers/>
</project>
