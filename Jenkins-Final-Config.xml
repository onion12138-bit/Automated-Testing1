<?xml version='1.1' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Ford Smart Badge è‡ªåŠ¨åŒ–æµ‹è¯•ä»»åŠ¡ - æœ€ç»ˆç‰ˆæœ¬
å®šæ—¶è®¾ç½®: æ—©ä¸Š9ç‚¹, ä¸‹åˆ2ç‚¹, æ™šä¸Š6ç‚¹
ä½¿ç”¨ç»å¯¹è·¯å¾„antå‘½ä»¤ï¼Œç¡®ä¿ç¨³å®šæ‰§è¡Œ</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>WORKSPACE_DIR</name>
          <description>å·¥ä½œç›®å½•è·¯å¾„</description>
          <defaultValue>/Users/onion/Desktop/JmeterMac2</defaultValue>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers>
    <hudson.triggers.TimerTrigger>
      <spec>0 9,14,18 * * *</spec>
    </hudson.triggers.TimerTrigger>
  </triggers>
  <concurrentBuild>false</concurrentBuild>
  <customWorkspace>/Users/onion/Desktop/JmeterMac2</customWorkspace>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash

echo "========================================="
echo "ğŸš€ Ford Smart Badge è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬"
echo "========================================="
echo "æ‰§è¡Œæ—¶é—´: $(date)"
echo "Jenkinså·¥ä½œç›®å½•: $WORKSPACE"
echo "å®šæ—¶è®¾ç½®: æ—©ä¸Š9ç‚¹, ä¸‹åˆ2ç‚¹, æ™šä¸Š6ç‚¹"
echo "========================================="

# è®¾ç½®å·¥ä½œç›®å½•
WORKSPACE_DIR="/Users/onion/Desktop/JmeterMac2"
cd "$WORKSPACE_DIR"

# è®°å½•æ—¥å¿—
LOG_FILE="$WORKSPACE_DIR/jenkins-test.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "=========================================" >> "$LOG_FILE"
echo "ğŸ• Jenkinså¼€å§‹æ‰§è¡Œæ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯• - $TIMESTAMP" >> "$LOG_FILE"
echo "=========================================" >> "$LOG_FILE"

# æ£€æŸ¥å·¥ä½œç›®å½•
if [ ! -d "$WORKSPACE_DIR" ]; then
    echo "âŒ é”™è¯¯: å·¥ä½œç›®å½•ä¸å­˜åœ¨: $WORKSPACE_DIR" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: å·¥ä½œç›®å½•ä¸å­˜åœ¨: $WORKSPACE_DIR"
    exit 1
fi

echo "ğŸ“ å·¥ä½œç›®å½•: $WORKSPACE_DIR" >> "$LOG_FILE"
echo "ğŸ“ å·¥ä½œç›®å½•: $WORKSPACE_DIR"

# æ£€æŸ¥å¿…è¦æ–‡ä»¶
if [ ! -f "$WORKSPACE_DIR/build.xml" ]; then
    echo "âŒ é”™è¯¯: build.xmlæ–‡ä»¶ä¸å­˜åœ¨" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: build.xmlæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

if [ ! -f "$WORKSPACE_DIR/jmeter-script/Ford-Smart-API-Test.jmx" ]; then
    echo "âŒ é”™è¯¯: JMeteræµ‹è¯•è„šæœ¬ä¸å­˜åœ¨" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: JMeteræµ‹è¯•è„šæœ¬ä¸å­˜åœ¨"
    exit 1
fi

echo "âœ… å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡" >> "$LOG_FILE"
echo "âœ… å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

# ä½¿ç”¨antçš„ç»å¯¹è·¯å¾„
ANT_PATH="/opt/homebrew/bin/ant"
echo "ğŸ” ä½¿ç”¨antç»å¯¹è·¯å¾„: $ANT_PATH" >> "$LOG_FILE"
echo "ğŸ” ä½¿ç”¨antç»å¯¹è·¯å¾„: $ANT_PATH"

# æ£€æŸ¥antæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$ANT_PATH" ]; then
    echo "âŒ é”™è¯¯: antæ–‡ä»¶ä¸å­˜åœ¨: $ANT_PATH" >> "$LOG_FILE"
    echo "âŒ é”™è¯¯: antæ–‡ä»¶ä¸å­˜åœ¨: $ANT_PATH"
    exit 1
fi

# æ˜¾ç¤ºantç‰ˆæœ¬ä¿¡æ¯
echo "ğŸ“‹ antç‰ˆæœ¬ä¿¡æ¯:" >> "$LOG_FILE"
echo "ğŸ“‹ antç‰ˆæœ¬ä¿¡æ¯:"
"$ANT_PATH" -version >> "$LOG_FILE" 2>&1
"$ANT_PATH" -version

# æ‰§è¡ŒAntæ„å»º
echo "ğŸš€ å¼€å§‹æ‰§è¡ŒAntæ„å»º..." >> "$LOG_FILE"
echo "ğŸš€ å¼€å§‹æ‰§è¡ŒAntæ„å»º..."
"$ANT_PATH" run >> "$LOG_FILE" 2>&1
ANT_EXIT_CODE=$?

echo "Antæ‰§è¡Œé€€å‡ºç : $ANT_EXIT_CODE" >> "$LOG_FILE"
echo "Antæ‰§è¡Œé€€å‡ºç : $ANT_EXIT_CODE"

# æ£€æŸ¥æ‰§è¡Œç»“æœ
if [ $ANT_EXIT_CODE -eq 0 ]; then
    echo "âœ… Antæ„å»ºæ‰§è¡ŒæˆåŠŸ" >> "$LOG_FILE"
    echo "âœ… Antæ„å»ºæ‰§è¡ŒæˆåŠŸ"
    
    # æŸ¥æ‰¾æœ€æ–°çš„ZIPæŠ¥å‘Šæ–‡ä»¶
    LATEST_ZIP=$(ls -t /tmp/JMeter_Report_*.zip 2>/dev/null | head -1)
    
    if [ -n "$LATEST_ZIP" ] && [ -f "$LATEST_ZIP" ]; then
        echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š: $LATEST_ZIP" >> "$LOG_FILE"
        echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š: $LATEST_ZIP"
        
        # å‘é€é‚®ä»¶é€šçŸ¥
        echo "ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥..." >> "$LOG_FILE"
        echo "ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥..."
        
        # ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶
        if [ -f "$WORKSPACE_DIR/send-email-python.py" ]; then
            echo "ğŸ ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶..." >> "$LOG_FILE"
            echo "ğŸ ä½¿ç”¨Pythonè„šæœ¬å‘é€é‚®ä»¶..."
            
            cd "$WORKSPACE_DIR"
            python3 send-email-python.py
            MAIL_RESULT=$?
            
            if [ $MAIL_RESULT -eq 0 ]; then
                echo "âœ… é‚®ä»¶å‘é€æˆåŠŸ (ä½¿ç”¨Pythonè„šæœ¬)" >> "$LOG_FILE"
                echo "âœ… é‚®ä»¶å‘é€æˆåŠŸ (ä½¿ç”¨Pythonè„šæœ¬)"
            else
                echo "âŒ Pythoné‚®ä»¶å‘é€å¤±è´¥" >> "$LOG_FILE"
                echo "âŒ Pythoné‚®ä»¶å‘é€å¤±è´¥"
            fi
        else
            echo "âŒ Pythoné‚®ä»¶è„šæœ¬ä¸å­˜åœ¨" >> "$LOG_FILE"
            echo "âŒ Pythoné‚®ä»¶è„šæœ¬ä¸å­˜åœ¨"
        fi
    else
        echo "âš ï¸ æœªæ‰¾åˆ°ZIPæŠ¥å‘Šæ–‡ä»¶" >> "$LOG_FILE"
        echo "âš ï¸ æœªæ‰¾åˆ°ZIPæŠ¥å‘Šæ–‡ä»¶"
    fi
else
    echo "âŒ Antæ„å»ºæ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $ANT_EXIT_CODE)" >> "$LOG_FILE"
    echo "âŒ Antæ„å»ºæ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $ANT_EXIT_CODE)"
    echo "è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶: $LOG_FILE" >> "$LOG_FILE"
    echo "è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    exit 1
fi

# è®°å½•å®Œæˆæ—¶é—´
END_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "=========================================" >> "$LOG_FILE"
echo "ğŸ Jenkinsæ¯æ—¥è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ - $END_TIMESTAMP" >> "$LOG_FILE"
echo "=========================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find "$WORKSPACE_DIR" -name "jenkins-test.log" -mtime +30 -delete 2>/dev/null

echo "========================================="
echo "ğŸ‰ Jenkinsè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬æ‰§è¡Œå®Œæˆï¼"
echo "ğŸ“§ æµ‹è¯•æŠ¥å‘Šå·²å‘é€åˆ°: 2335327949@qq.com"
echo "ğŸ“„ è¯¦ç»†æ—¥å¿—: $LOG_FILE"
echo "â° ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´: æ—©ä¸Š9ç‚¹, ä¸‹åˆ2ç‚¹, æ™šä¸Š6ç‚¹"
echo "========================================="</command>
      <configuredLocalRules/>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <!-- ç§»é™¤Jenkinsé»˜è®¤é‚®ä»¶æ’ä»¶ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„Pythonè„šæœ¬ -->
  </publishers>
  <buildWrappers/>
</project>
